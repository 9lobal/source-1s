// < vtrushnikov@1cbit.ru
// пример вызова 
// КонсольЗапросовОбщий.ВыгрузитьЗапросВФайлы(Запрос, "C:\Users\1cbit.trushnikov\Documents\КонсольЗапросов\Запросы\1");
Функция ВыгрузитьЗапросВФайлы(Запрос, Каталог) Экспорт
	ИмяСобытия = "КонсольЗапросовОбщий.ВыгрузкаЗапроса." + Новый УникальныйИдентификатор;
	Если ТипЗнч(Запрос) = Тип("Запрос") Тогда
		Если Не Запрос.МенеджерВременныхТаблиц = Неопределено Тогда
			Путь = Каталог + "\МенеджерВременныхТаблиц.xml";
			Результат = ВыгрузитьМенеджерВременныхТаблиц(Запрос);
			Если ТипЗнч(Результат) = Тип("Структура") Тогда
				ЗаписьТекста = Новый ЗаписьТекста;
				Попытка
					ЗаписьТекста.Открыть(Путь);
					ЗаписьТекста.Записать(Сериализовать(Результат));
					ЗаписьТекста.Закрыть();
					Возврат "";
				Исключение
					Возврат ОписаниеОшибки()
				КонецПопытки;
			ИначеЕсли
				Не ПустаяСтрока(Результат) Тогда
				ЗаписатьОшибкуВЛог(ИмяСобытия, Результат);
				Возврат Результат
			КонецЕсли;
		КонецЕсли;
		Путь = Каталог + "\ПараметрыЗапроса.xml";
		Результат = ВыгрузитьПараметрыЗапроса(Запрос);
		Если ТипЗнч(Результат) = Тип("Структура") Тогда
			ЗаписьТекста = Новый ЗаписьТекста;
			Попытка
				ЗаписьТекста.Открыть(Путь);
				ЗаписьТекста.Записать(Сериализовать(Результат));
				ЗаписьТекста.Закрыть();
				Возврат "";
			Исключение
				Возврат ОписаниеОшибки()
			КонецПопытки;
		ИначеЕсли
			Не ПустаяСтрока(Результат) Тогда
			ЗаписатьОшибкуВЛог(ИмяСобытия, Результат);
			Возврат Результат
		КонецЕсли;
		
		Путь = Каталог + "\Запрос.txt";
		Результат = ВыгрузитьТекстЗапроса(Запрос);
		ЗаписьТекста = Новый ЗаписьТекста;
		Попытка
			ЗаписьТекста.Открыть(Путь);
			ЗаписьТекста.Записать(Сериализовать(Результат));
			ЗаписьТекста.Закрыть();
			Возврат "";
		Исключение
			Возврат ОписаниеОшибки()
		КонецПопытки;
		Возврат Каталог;
	Иначе
		Возврат "Неверный параметр 1: ожидается Тип(""Запрос"")";
	КонецЕсли;
КонецФункции

Функция ВыгрузитьЗапросВХранилище(Запрос, КлючНастроек="НастройкиКонсолиЗапросов") Экспорт
	ИмяСобытия = "КонсольЗапросовОбщий.ВыгрузкаЗапроса." + Новый УникальныйИдентификатор;
	Если ТипЗнч(Запрос) = Тип("Запрос") Тогда
		Структура = Новый Структура;
		Если Не Запрос.МенеджерВременныхТаблиц = Неопределено Тогда
			СтруктураМенеджерВременныхТаблиц = ВыгрузитьМенеджерВременныхТаблиц(Запрос);
			Если ТипЗнч(СтруктураМенеджерВременныхТаблиц) = Тип("Строка") Тогда
				ЗаписатьОшибкуВЛог(ИмяСобытия, СтруктураМенеджерВременныхТаблиц);
				Возврат СтруктураМенеджерВременныхТаблиц
			КонецЕсли;
			Структура.Вставить("МенеджерВременныхТаблиц", СтруктураМенеджерВременныхТаблиц);
		КонецЕсли;
		СтруктураПараметры = ВыгрузитьПараметрыЗапроса(Запрос);
		Если ТипЗнч(СтруктураПараметры) = Тип("Строка") Тогда
			ЗаписатьОшибкуВЛог(ИмяСобытия, СтруктураПараметры);
			Возврат СтруктураПараметры
		КонецЕсли;
		Структура.Вставить("Параметры", СтруктураПараметры);
		Структура.Вставить("ТекстЗапроса", ВыгрузитьТекстЗапроса(Запрос));
		ХранилищеОбщихНастроек.Сохранить("КонсольЗапросов", КлючНастроек, Структура);
		Возврат КлючНастроек;
	Иначе
		Возврат "Неверный параметр 1: ожидается Тип(""Запрос"")";
	КонецЕсли;
КонецФункции

Функция ВыгрузитьТекстЗапроса(Запрос) Экспорт
	Если Не ТипЗнч(Запрос) = Тип("Запрос") Тогда
		Возврат "Неверный параметр 1: ожидается Тип(""Запрос"")";
	КонецЕсли;
	Возврат СокрЛП(Запрос.Текст)
КонецФункции

// пример вызова 
// КонсольЗапросовОбщий.ВыгрузитьМенеджерВременныхТаблицВФайл(МенеджерВременныхТаблиц, "C:\Users\1cbit.trushnikov\Documents\Конфигурация\ВыгрузкиМВТ\РассчитатьЗачетАвансовПолученных.xml");
Функция ВыгрузитьМенеджерВременныхТаблиц(ЗапросИлиМВТ) Экспорт
	МВТ = Неопределено;
	Если ТипЗнч(ЗапросИлиМВТ) = Тип("МенеджерВременныхТаблиц") Тогда
		МВТ = ЗапросИлиМВТ;
	ИначеЕсли ТипЗнч(ЗапросИлиМВТ) = Тип("Запрос") Тогда
		МВТ = ЗапросИлиМВТ.МенеджерВременныхТаблиц;
	Иначе
		Возврат "Неверный параметр 1: ожидается Тип(""МенеджерВременныхТаблиц"") или Тип(""Запрос"")";
	КонецЕсли;
	Структура = Новый Структура;
	Для Каждого ВременнаяТаблица Из МВТ.Таблицы Цикл
		ИмяВременнойТаблицы = ВременнаяТаблица.ПолноеИмя;
		Структура.Вставить(ИмяВременнойТаблицы, ВременнаяТаблица.ПолучитьДанные().Выгрузить());
	КонецЦикла;
	Возврат Структура
КонецФункции

// пример вызова 
// КонсольЗапросовОбщий.ВыгрузитьПараметрыЗапросаВФайл(Запрос, "C:\Users\1cbit.trushnikov\Documents\КонсольЗапросов\Запросы\1\Параметры.xml");
Функция ВыгрузитьПараметрыЗапроса(Запрос) Экспорт
	Если Не ТипЗнч(Запрос) = Тип("Запрос") Тогда
		Возврат "Неверный параметр 1: ожидается Тип(""Запрос"")";
	КонецЕсли;
	Структура = Новый Структура;
	Для Каждого ТекущийПараметр Из Запрос.Параметры Цикл
		Структура.Вставить(ТекущийПараметр.Ключ, ТекущийПараметр.Значение);
	КонецЦикла;
	Возврат Структура
КонецФункции

Функция Десериализовать(XMLСтруктураСериализованногоОбъекта) Экспорт
	ЧтениеXMLДанных = Новый ЧтениеXML;
	ЧтениеXMLДанных.УстановитьСтроку(XMLСтруктураСериализованногоОбъекта);
	ТЗ = СериализаторXDTO.ПрочитатьXML(ЧтениеXMLДанных);
	ЧтениеXMLДанных.Закрыть();  
	Возврат ТЗ;
КонецФункции

Функция Сериализовать(ОбъектСериализации) Экспорт
	ДеревоВОбъектеXDTO = СериализаторXDTO.ЗаписатьXDTO(ОбъектСериализации);
	МойXML = Новый ЗаписьXML;
	МойXML.УстановитьСтроку();
	ФабрикаXDTO.ЗаписатьXML(МойXML, ДеревоВОбъектеXDTO);
	Возврат МойXML.Закрыть();
КонецФункции

Процедура ЗаписатьОшибкуВЛог(ИмяСобытия, Текст)

	ЗаписьЖурналаРегистрации(ИмяСобытия, УровеньЖурналаРегистрации.Ошибка,,,Текст);

КонецПроцедуры

// vtrushnikov@1cbit.ru >